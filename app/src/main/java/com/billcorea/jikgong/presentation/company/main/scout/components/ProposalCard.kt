package com.billcorea.jikgong.presentation.company.main.scout.components

import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.Phone
import androidx.compose.material3.*
import androidx.compose.runtime.Composable
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.style.TextOverflow
import androidx.compose.ui.tooling.preview.Preview
import androidx.compose.ui.unit.dp
import com.billcorea.jikgong.api.models.sampleDataFactory.DataFactoryModels.Proposal
import com.billcorea.jikgong.api.models.sampleDataFactory.DataFactoryModels.ProposalStatus
import com.billcorea.jikgong.ui.theme.Jikgong1111Theme
import java.time.LocalDateTime
import java.time.format.DateTimeFormatter
import java.text.NumberFormat
import java.util.*

// Í∏àÏï°ÏóêÏÑú Ïà´Ïûê Ï∂îÏ∂ú Î∞è ÌòïÏãùÌôî Ìï®Ïàò
private fun formatProposalWage(wageString: String): String {
    // "ÏùºÎãπ 150000Ïõê", "ÏùºÎãπ 150000", "150000Ïõê" Îì±ÏóêÏÑú Ïà´ÏûêÎ•º Ï∂îÏ∂ú
    val numberRegex = "(\\d+)".toRegex()
    val matchResult = numberRegex.find(wageString)
    
    return if (matchResult != null) {
        val amount = matchResult.value.toIntOrNull() ?: return wageString
        "${amount}Ïõê"
    } else {
        wageString // ÌååÏã± Ïã§Ìå®Ïãú ÏõêÎ≥∏ Î∞òÌôò
    }
}

@Composable
fun ProposalCard(
  proposal: Proposal,
  onClick: () -> Unit,
  modifier: Modifier = Modifier
) {
  Card(
    modifier = modifier
      .fillMaxWidth()
      .clickable { onClick() },
    shape = RoundedCornerShape(16.dp),
    colors = CardDefaults.cardColors(
      containerColor = Color.White
    ),
    elevation = CardDefaults.cardElevation(
      defaultElevation = 2.dp
    )
  ) {
    Column(
      modifier = Modifier
        .fillMaxWidth()
        .padding(16.dp)
    ) {
      // ÏÉÅÎã®: ÏÉÅÌÉú Î±ÉÏßÄÏôÄ ÎÇ†Ïßú
      Row(
        modifier = Modifier.fillMaxWidth(),
        horizontalArrangement = Arrangement.SpaceBetween,
        verticalAlignment = Alignment.CenterVertically
      ) {
        // ÏÉÅÌÉú Î±ÉÏßÄ
        StatusBadge(status = proposal.status)

        // Ï†úÏïà ÎÇ†Ïßú
        Text(
          text = proposal.toDisplayInfo(),
          style = MaterialTheme.typography.bodySmall,
          color = Color.Gray
        )
      }

      Spacer(modifier = Modifier.height(12.dp))

      // ÎÖ∏ÎèôÏûê Ï†ïÎ≥¥
      Row(
        modifier = Modifier.fillMaxWidth(),
        horizontalArrangement = Arrangement.SpaceBetween,
        verticalAlignment = Alignment.Top
      ) {
        Column(modifier = Modifier.weight(1f)) {
          Text(
            text = proposal.workerName,
            style = MaterialTheme.typography.titleMedium.copy(
              fontWeight = FontWeight.Bold
            )
          )

          Spacer(modifier = Modifier.height(4.dp))

          Text(
            text = proposal.jobTypes.joinToString(" ¬∑ "),
            style = MaterialTheme.typography.bodyMedium.copy(
              fontWeight = FontWeight.Medium
            ),
            color = Color.Black
          )

          Spacer(modifier = Modifier.height(8.dp))

          // ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Ïπ¥Îìú
          Surface(
            modifier = Modifier.fillMaxWidth(),
            shape = RoundedCornerShape(8.dp),
            color = Color(0xFFF8F9FA)
          ) {
            Column(
              modifier = Modifier.padding(12.dp),
              verticalArrangement = Arrangement.spacedBy(4.dp)
            ) {
              Row(
                modifier = Modifier.fillMaxWidth(),
                horizontalArrangement = Arrangement.spacedBy(16.dp)
              ) {
                InfoItem(
                  icon = "üìç",
                  label = "Í±∞Î¶¨",
                  value = proposal.distance,
                  modifier = Modifier.weight(1f)
                )
                InfoItem(
                  icon = "‚≠ê",
                  label = "ÌèâÏ†ê",
                  value = "4.5", // Mock data
                  modifier = Modifier.weight(1f)
                )
              }
              
              Row(
                modifier = Modifier.fillMaxWidth(),
                horizontalArrangement = Arrangement.spacedBy(16.dp)
              ) {
                InfoItem(
                  icon = "üíº",
                  label = "Í≤ΩÎ†•",
                  value = "5ÎÖÑ", // Mock data
                  modifier = Modifier.weight(1f)
                )
                InfoItem(
                  icon = "‚úÖ",
                  label = "ÏôÑÎ£å",
                  value = "52Í±¥", // Mock data
                  modifier = Modifier.weight(1f)
                )
              }
              
              // Ï†úÏïà Í∏àÏï°ÏùÑ Îçî ÎààÏóê ÎùÑÍ≤å
              Divider(
                modifier = Modifier.padding(vertical = 4.dp),
                color = Color(0xFFE0E0E0),
                thickness = 0.5.dp
              )
              
              Row(
                modifier = Modifier.fillMaxWidth(),
                horizontalArrangement = Arrangement.SpaceBetween,
                verticalAlignment = Alignment.CenterVertically
              ) {
                Text(
                  text = "Ï†úÏïà ÏùºÎãπ",
                  style = MaterialTheme.typography.bodySmall,
                  color = Color.Gray
                )
                Text(
                  text = formatProposalWage(proposal.proposedWage),
                  style = MaterialTheme.typography.bodyLarge.copy(
                    fontWeight = FontWeight.Bold
                  ),
                  color = Color(0xFF4B7BFF)
                )
              }
            }
          }
        }
      }

      // Î©îÏãúÏßÄ
      if (proposal.message.isNotEmpty()) {
        Spacer(modifier = Modifier.height(12.dp))

        Surface(
          modifier = Modifier.fillMaxWidth(),
          shape = RoundedCornerShape(8.dp),
          color = Color(0xFFF5F5F5)
        ) {
          Text(
            text = proposal.message,
            modifier = Modifier.padding(12.dp),
            style = MaterialTheme.typography.bodySmall,
            maxLines = 2,
            overflow = TextOverflow.Ellipsis
          )
        }
      }

      // ÏàòÎùΩÎêú Í≤ΩÏö∞ Ïó∞ÎùΩÏ≤ò ÌëúÏãú
      if (proposal.status == ProposalStatus.ACCEPTED && proposal.workerPhone != null) {
        Spacer(modifier = Modifier.height(12.dp))

        Surface(
          modifier = Modifier
            .fillMaxWidth()
            .clip(RoundedCornerShape(8.dp))
            .clickable { /* TODO: Ï†ÑÌôî Í±∏Í∏∞ */ },
          color = Color(0xFF4B7BFF).copy(alpha = 0.1f)
        ) {
          Row(
            modifier = Modifier.padding(12.dp),
            verticalAlignment = Alignment.CenterVertically,
            horizontalArrangement = Arrangement.Center
          ) {
            Icon(
              imageVector = Icons.Default.Phone,
              contentDescription = "Ï†ÑÌôî",
              modifier = Modifier.size(16.dp),
              tint = Color(0xFF4B7BFF)
            )
            Spacer(modifier = Modifier.width(8.dp))
            Text(
              text = proposal.workerPhone,
              style = MaterialTheme.typography.bodyMedium.copy(
                fontWeight = FontWeight.Medium
              ),
              color = Color(0xFF4B7BFF)
            )
          }
        }
      }

      // ÏùëÎãµ ÏãúÍ∞Ñ (ÏàòÎùΩ/Í±∞Ï†àÎêú Í≤ΩÏö∞)
      if (proposal.respondedAt != null) {
        Spacer(modifier = Modifier.height(8.dp))
        Text(
          text = "ÏùëÎãµ: ${proposal.respondedAt.format(DateTimeFormatter.ofPattern("MMÏõî ddÏùº HH:mm"))}",
          style = MaterialTheme.typography.labelSmall,
          color = Color.Gray
        )
      }

      // Í±∞Ï†à ÏÇ¨Ïú† (Í±∞Ï†àÎêú Í≤ΩÏö∞)
      if (proposal.status == ProposalStatus.REJECTED && proposal.rejectReason != null) {
        Spacer(modifier = Modifier.height(8.dp))
        Surface(
          modifier = Modifier.fillMaxWidth(),
          shape = RoundedCornerShape(8.dp),
          color = Color(0xFFFFEBEE)
        ) {
          Text(
            text = "Í±∞Ï†à ÏÇ¨Ïú†: ${proposal.rejectReason}",
            modifier = Modifier.padding(12.dp),
            style = MaterialTheme.typography.bodySmall,
            color = Color(0xFFC62828)
          )
        }
      }
    }
  }
}

@Composable
private fun InfoItem(
  icon: String,
  label: String,
  value: String,
  modifier: Modifier = Modifier
) {
  Row(
    modifier = modifier,
    verticalAlignment = Alignment.CenterVertically,
    horizontalArrangement = Arrangement.spacedBy(4.dp)
  ) {
    Text(
      text = icon,
      style = MaterialTheme.typography.bodySmall
    )
    Column {
      Text(
        text = label,
        style = MaterialTheme.typography.labelSmall,
        color = Color.Gray
      )
      Text(
        text = value,
        style = MaterialTheme.typography.bodySmall.copy(
          fontWeight = FontWeight.Medium
        ),
        color = Color.Black
      )
    }
  }
}

@Composable
private fun StatusBadge(status: ProposalStatus) {
  val (backgroundColor, textColor, text) = when (status) {
    ProposalStatus.PENDING -> Triple(
      Color(0xFFFFF3E0),
      Color(0xFFFF6F00),
      "ÎåÄÍ∏∞Ï§ë"
    )
    ProposalStatus.ACCEPTED -> Triple(
      Color(0xFFE8F5E9),
      Color(0xFF2E7D32),
      "ÏàòÎùΩÎê®"
    )
    ProposalStatus.REJECTED -> Triple(
      Color(0xFFFFEBEE),
      Color(0xFFC62828),
      "Í±∞Ï†àÎê®"
    )
  }

  Surface(
    shape = RoundedCornerShape(12.dp),
    color = backgroundColor
  ) {
    Text(
      text = text,
      modifier = Modifier.padding(horizontal = 12.dp, vertical = 4.dp),
      style = MaterialTheme.typography.labelSmall.copy(
        fontWeight = FontWeight.Bold
      ),
      color = textColor
    )
  }
}

@Preview(showBackground = true, backgroundColor = 0xFFF7F8FA)
@Composable
fun ProposalCardPendingPreview() {
  Jikgong1111Theme {
    ProposalCard(
      proposal = Proposal(
        id = "1",
        workerId = "worker1",
        workerName = "ÍπÄÏ≤†Ïàò",
        proposedWage = "ÏùºÎãπ 20ÎßåÏõê",
        message = "ÌîÑÎ°úÏ†ùÌä∏Ïóê Íº≠ ÌïÑÏöîÌïú Ïù∏Î†•ÏûÖÎãàÎã§. Ï¢ãÏùÄ Ï°∞Í±¥ÏúºÎ°ú Î™®ÏãúÍ≥† Ïã∂ÏäµÎãàÎã§.",
        status = ProposalStatus.PENDING,
        createdAt = LocalDateTime.now().minusHours(2),
        respondedAt = null,
        jobTypes = listOf("Ï≤†Í∑ºÍ≥µ", "ÌòïÌãÄÎ™©Í≥µ"),
        distance = "2.5km",
        workerPhone = null,
        rejectReason = null
      ),
      onClick = {},
      modifier = Modifier.padding(16.dp)
    )
  }
}

@Preview(showBackground = true, backgroundColor = 0xFFF7F8FA)
@Composable
fun ProposalCardAcceptedPreview() {
  Jikgong1111Theme {
    ProposalCard(
      proposal = Proposal(
        id = "2",
        workerId = "worker2",
        workerName = "Ïù¥ÏòÅÌù¨",
        proposedWage = "ÏùºÎãπ 18ÎßåÏõê",
        message = "Í≤ΩÎ†•Ïù¥ ÌíçÎ∂ÄÌïòÏã† Î∂ÑÏùÑ Ï∞æÍ≥† ÏûàÏäµÎãàÎã§.",
        status = ProposalStatus.ACCEPTED,
        createdAt = LocalDateTime.now().minusDays(1),
        respondedAt = LocalDateTime.now().minusHours(3),
        jobTypes = listOf("ÌÉÄÏùºÍ≥µ"),
        distance = "1.2km",
        workerPhone = "010-1234-5678",
        rejectReason = null
      ),
      onClick = {},
      modifier = Modifier.padding(16.dp)
    )
  }
}

@Preview(showBackground = true, backgroundColor = 0xFFF7F8FA)
@Composable
fun ProposalCardRejectedPreview() {
  Jikgong1111Theme {
    ProposalCard(
      proposal = Proposal(
        id = "3",
        workerId = "worker3",
        workerName = "Î∞ïÎØºÏàò",
        proposedWage = "ÏùºÎãπ 15ÎßåÏõê",
        message = "Ìï®Íªò ÏùºÌïòÍ≥† Ïã∂ÏäµÎãàÎã§.",
        status = ProposalStatus.REJECTED,
        createdAt = LocalDateTime.now().minusDays(2),
        respondedAt = LocalDateTime.now().minusDays(1),
        jobTypes = listOf("Ï†ÑÍ∏∞Í≥µ"),
        distance = "3.5km",
        workerPhone = null,
        rejectReason = "ÏùºÏ†ïÏù¥ ÎßûÏßÄ ÏïäÏäµÎãàÎã§"
      ),
      onClick = {},
      modifier = Modifier.padding(16.dp)
    )
  }
}